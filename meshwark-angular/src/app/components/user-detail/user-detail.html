<div class="container mt-4 user-detail-container" style="direction: rtl;">
  <button (click)="goBack()" class="btn btn-outline-secondary mb-3">
    <i class="fas fa-arrow-right me-2"></i> العودة
  </button>

  <div *ngIf="isLoading" class="text-center my-5">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
      <span class="visually-hidden">جاري التحميل...</span>
    </div>
    <p class="mt-2">جاري تحميل تفاصيل المستخدم...</p>
  </div>

  <div *ngIf="error && !isLoading" class="alert alert-danger shadow-sm">
    <i class="fas fa-exclamation-triangle me-2"></i> {{ error }}
  </div>

  <div *ngIf="user && !isLoading && !error" class="card shadow-lg">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
      <h2 class="mb-0" style="color: #4C6DAA;">
        تفاصيل المستخدم: {{ user.firstName }} {{ user.lastName }}
      </h2>
      <div>
        <button *ngIf="!isEditing" (click)="toggleEditMode()" class="btn btn-outline-primary btn-sm me-2">
            <i class="fas fa-edit me-1"></i> تعديل
        </button>
        <button *ngIf="isEditing" (click)="saveUserDetails()" class="btn btn-success btn-sm me-2" [disabled]="isLoading">
            <i class="fas fa-save me-1"></i> حفظ
        </button>
        <button *ngIf="isEditing" (click)="toggleEditMode()" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-times me-1"></i> إلغاء
        </button>
      </div>
    </div>
    <div class="card-body">
      <div class="row">
        <!-- User Info Column -->
        <div class="col-md-8">
          <form #editForm="ngForm" (ngSubmit)="saveUserDetails()">
            <table class="table table-borderless table-user-info">
              <tbody>
                <tr>
                  <th scope="row" style="width: 150px;">المعرف (ID):</th>
                  <td>{{ user.id }}</td>
                </tr>
                <tr>
                  <th scope="row">الاسم الأول:</th>
                  <td>
                    <span *ngIf="!isEditing">{{ user.firstName }}</span>
                    <input *ngIf="isEditing" type="text" class="form-control form-control-sm" [(ngModel)]="editableUser!.firstName" name="firstName" required>
                  </td>
                </tr>
                <tr>
                  <th scope="row">الاسم الأخير:</th>
                  <td>
                    <span *ngIf="!isEditing">{{ user.lastName }}</span>
                    <input *ngIf="isEditing" type="text" class="form-control form-control-sm" [(ngModel)]="editableUser!.lastName" name="lastName" required>
                  </td>
                </tr>
                <tr>
                  <th scope="row">البريد الإلكتروني:</th>
                  <td>
                    <span *ngIf="!isEditing">{{ user.email }}</span>
                    <input *ngIf="isEditing" type="email" class="form-control form-control-sm" [(ngModel)]="editableUser!.email" name="email" required email>
                  </td>
                </tr>
                 <tr>
                  <th scope="row">رقم الهاتف:</th>
                  <td>
                    <span *ngIf="!isEditing">{{ user.phoneNumber || 'غير متوفر' }}</span>
                    <input *ngIf="isEditing" type="text" class="form-control form-control-sm" [(ngModel)]="editableUser!.phoneNumber" name="phoneNumber">
                  </td>
                </tr>
                <tr>
                  <th scope="row">نوع المستخدم:</th>
                  <td>{{ translateUserType(user.userType) }}</td> <!-- Not typically editable -->
                </tr>
                <tr>
                  <th scope="row">الحالة:</th>
                  <td>
                    <span class="badge fs-6" [ngClass]="user.isActive ? 'bg-success-soft text-success' : 'bg-danger-soft text-danger'">
                      {{ user.isActive ? 'مفعل' : 'غير مفعل' }}
                    </span>
                    <button *ngIf="!isEditing" (click)="toggleUserStatus()" class="btn btn-link btn-sm ms-2">
                      {{ user.isActive ? 'تعطيل الحساب' : 'تفعيل الحساب' }}
                    </button>
                  </td>
                </tr>
                <tr *ngIf="user.registrationDate">
                    <th scope="row">تاريخ التسجيل:</th>
                    <td>{{ user.registrationDate | date:'yyyy/MM/dd hh:mm a' }}</td>
                </tr>
                <tr *ngIf="user.tripsCount !== undefined">
                    <th scope="row">عدد الرحلات:</th>
                    <td>{{ user.tripsCount }}</td>
                </tr>
                <!-- Add more fields as needed -->
              </tbody>
            </table>
          </form>
        </div>
        <!-- QR Code and Profile Image Column -->
        <div class="col-md-4 text-center">
          <div *ngIf="user.profileImage" class="mb-3">
            <img [src]="user.profileImage" alt="صورة الملف الشخصي" class="img-thumbnail profile-image rounded-circle"
                 onerror="this.src='assets/images/default-profile.png'"> <!-- Fallback image -->
          </div>
          <div *ngIf="!user.profileImage" class="mb-3">
            <img src="assets/images/default-profile.png" alt="صورة الملف الشخصي الافتراضية" class="img-thumbnail profile-image rounded-circle">
          </div>

          <div *ngIf="qrCodeValue" class="mt-3 qr-code-container">
            <h5>رمز QR (للمعرف):</h5>
            <qr-code [value]="qrCodeValue" [size]="150"></qr-code>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
